x-build-defaults: &build-defaults
  args:
    BUILDKIT_PROGRESS: plain

services:
  postgres:
    image: host.docker.internal:5128/cgr.dev/chainguard/postgres
    container_name: pg17-local
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: rank-nsf-linker
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./server/conf/pg_hba.dev.conf:/etc/postgresql/pg_hba.conf:ro
      - ./server/conf/postgresql.dev.conf:/etc/postgresql/postgresql.conf:ro
      - ./server/certs:/certs:ro
    command:
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
      - "-c"
      - "hba_file=/etc/postgresql/pg_hba.conf"
      - "-c"
      - "ssl=on"
      - "-c"
      - "ssl_cert_file=/certs/server.crt"
      - "-c"
      - "ssl_key_file=/certs/server.key"
      - "-c"
      - "ssl_ca_file=/certs/ca.crt"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    networks:
      - default

  elasticsearch:
    image: host.docker.internal:5128/docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    container_name: es-local
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - bootstrap.memory_lock=true
    ports:
      - "9200:9200"
      - "9300:9300"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_data:/usr/share/elasticsearch/data
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: "2G"
        reservations:
          cpus: "1.0"
          memory: "1G"
    restart: unless-stopped
    networks:
      - default

  qdrant:
    image: host.docker.internal:5128/qdrant/qdrant:v1.3.0
    container_name: qdrant-local
    ports:
      - "6333:6333" # HTTP/REST API
      - "6334:6334" # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: "4G"
        reservations:
          cpus: "1.0"
          memory: "2G"
    networks:
      - default

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    ports:
      - "9090:9090"
    depends_on:
      - pg-exporter
      - embedder
    networks:
      - default

  # Grafana
  grafana:
    image: grafana/grafana:12.3.0-18733571275-ubuntu
    container_name: grafana
    environment:
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
      - prometheus
    networks:
      - default

  # Postgres Exporter
  pg-exporter:
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres:5432/postgres?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      - postgres
    networks:
      - default

  scraper-worker:
    image: host.docker.internal:5128/scraper-worker:latest
    container_name: scraper-worker
    build:
      context: ./scraper_worker
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-scraper-worker:latest
    volumes:
      - ./scraper_worker/.env:/app/.env:ro
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_started
      qdrant:
        condition: service_started
    environment:
      DEBUG: 1
      DB_URL: postgres://postgres:postgres@pg17-local:5432/rank-nsf-linker
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: rank-nsf-linker
      DB_USER: postgres
      DB_PASSWORD: postgres
      ES_HOST: http://es-local:9200
      QDRANT_HOST: qdrant-local
      QDRANT_PORT: 6334 # gRPC port for Go client
      # PostgreSQL for research service
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB_NAME: rank-nsf-linker
      # Persistent Cache for Hugging Face Models
      HF_HOME: /app/data/hf_cache
      EMBEDDER_SERVICE_URL: http://embedder:8000
    mem_limit: 2g
    shm_size: 512mb
    restart: on-failure
    ports:
      - "2112:2112" # Prometheus metrics endpoint
    command: ["./scraper_worker/scraper_worker"]
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: "2G"
        reservations:
          cpus: "0.5"
          memory: "512M"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://scraper-worker:8080/health"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - default

  go-server:
    image: host.docker.internal:5128/go-server:latest
    container_name: go-server
    build:
      context: ./server
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-go-server:latest
    volumes:
      - ./server/.env:/app/.env:ro
      - ./data:/app/data:rw
      - ./backup:/app/backup:rw
      - ./target:/app/target:rw
      - ./certs:/certs:ro
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_started
      qdrant:
        condition: service_started
    environment:
      DB_URL: postgres://postgres:postgres@pg17-local:5432/rank-nsf-linker
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: rank-nsf-linker
      DB_USER: postgres
      DB_PASSWORD: postgres
      ES_HOST: http://es-local:9200
      QDRANT_HOST: qdrant-local
      QDRANT_PORT: 6334 # gRPC port for Go client
      # PostgreSQL for research service
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB_NAME: rank-nsf-linker
      # Persistent Cache for Hugging Face Models
      HF_HOME: /app/data/hf_cache
    ports:
      - "8080:8080"
    restart: unless-stopped
    command: ["./server/go-server"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://go-server:8080/health"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - default

  logging-service:
    image: host.docker.internal:5128/logging-service:latest
    container_name: logging-service
    build:
      context: ./logging-service
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-logging-service:latest
    volumes:
      - ./logging-service/.env:/app/.env:ro
    ports:
      - "5257:5257"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://logging-service:5257/health"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "512M"
        reservations:
          cpus: "0.1"
          memory: "128M"
    depends_on:
      - elasticsearch
    networks:
      - default

  web:
    image: host.docker.internal:5128/web-ui:latest
    container_name: web-ui
    build:
      context: ./web
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-web:latest
    volumes:
      - ./web/conf/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "3000:80" # Nginx in Dockerfile serves on 80, mapped to 3000 locally
    depends_on:
      - go-server
    restart: unless-stopped
    networks:
      - default

  embedder:
    image: rank-nsf-linker-embedder:latest
    container_name: embedder
    build:
      context: ./embedder
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-embedder:latest
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - MODEL_NAME=sentence-transformers/all-MiniLM-L6-v2
      - BATCH_SIZE=32
      - LOG_LEVEL=DEBUG
      - FLASK_DEBUG=true
    volumes:
      - ./embedder/app.py:/app/app.py:ro
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8000/health', timeout=5).raise_for_status()",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s # Faster now!
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 2G
    depends_on:
      - postgres
      - qdrant
      - scraper-worker
      - go-server
    networks:
      - default

volumes:
  pg_data:
  es_data:
  qdrant_data:
  prometheus_data:
  grafana_data:

networks:
  default:
    driver: bridge
