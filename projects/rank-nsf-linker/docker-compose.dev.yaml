services:
  postgres:
    image: host.docker.internal:5128/cgr.dev/chainguard/postgres
    container_name: pg17-local
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./server/conf/pg_hba.dev.conf:/etc/postgresql/pg_hba.conf:ro
      - ./server/conf/postgresql.dev.conf:/etc/postgresql/postgresql.conf:ro
      - ./server/certs:/certs:ro
    command:
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
      - "-c"
      - "hba_file=/etc/postgresql/pg_hba.conf"
      - "-c"
      - "ssl=on"
      - "-c"
      - "ssl_cert_file=/certs/server.crt"
      - "-c"
      - "ssl_key_file=/certs/server.key"
      - "-c"
      - "ssl_ca_file=/certs/ca.crt"
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    networks:
      - default

  elasticsearch:
    image: host.docker.internal:5128/docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    container_name: es-local
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - bootstrap.memory_lock=true
    ports:
      - "9200:9200"
      - "9300:9300"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: unless-stopped
    networks:
      - default

  qdrant:
    image: host.docker.internal:5128/qdrant/qdrant:v1.3.0
    container_name: qdrant-local
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - default

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - pg-exporter
    networks:
      - default

  # Grafana
  grafana:
    image: grafana/grafana:12.3.0-18733571275-ubuntu
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - default

  # Postgres Exporter
  pg-exporter:
    image: prometheuscommunity/postgres-exporter:v0.18.1
    container_name: pg-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:postgres@postgres:5432/postgres?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      - postgres
    networks:
      - default

  go-server:
    image: host.docker.internal:5128/go-server:latest
    container_name: go-server
    build:
      context: ./server
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-go-server:latest
    volumes:
      - ./server/.env:/app/.env:ro
      - ./data:/app/data:rw
      - ./backup:/app/backup:rw
      - ./target:/app/target:rw
      - ./certs:/certs:ro
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_started
      qdrant:
        condition: service_started
    environment:
      DB_URL: postgres://postgres:postgres@pg17-local:5432/mydb
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: mydb
      DB_USER: postgres
      DB_PASSWORD: postgres
      ES_HOST: http://es-local:9200
      QDRANT_HOST: http://qdrant-local:6333
    ports:
      - "8080:8080"
    restart: unless-stopped
    command: ["./server/go-server"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://go-server:8080/health"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      - default

  logging-service:
    image: host.docker.internal:5128/logging-service:latest
    container_name: logging-service
    build:
      context: ./logging-service
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-logging-service:latest
    volumes:
      - ./logging-service/.env:/app/.env:ro
    ports:
      - "5257:5257"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://logging-service:5257/health"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    depends_on:
      - elasticsearch
    networks:
      - default

  web:
    image: host.docker.internal:5128/web-ui:latest
    container_name: web-ui
    build:
      context: ./web
      dockerfile: Dockerfile
      tags:
        - rank-nsf-linker-web:latest
    volumes:
      - ./web/conf/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "3000:80"  # Nginx in Dockerfile serves on 80, mapped to 3000 locally
    depends_on:
      - go-server
    restart: unless-stopped
    networks:
      - default

volumes:
  pg_data:
  es_data:
  qdrant_data:

networks:
  default:
    driver: bridge
